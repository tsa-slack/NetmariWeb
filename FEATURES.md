# 機能詳細仕様

このドキュメントは、Netomariプラットフォームの各機能の詳細な仕様を説明します。

## 目次

- [車両管理機能](#車両管理機能)
- [レンタル予約機能](#レンタル予約機能)
- [コミュニティ機能](#コミュニティ機能)
- [協力店・ルート機能](#協力店ルート機能)
- [ユーザー管理機能](#ユーザー管理機能)
- [管理・スタッフ機能](#管理スタッフ機能)
- [通知機能](#通知機能)
- [ランクシステム](#ランクシステム)

---

## 車両管理機能

### 1. 車両カタログ

#### 概要
販売用・レンタル用のキャンピングカー情報を表示・管理する機能。

#### ユーザー向け機能

**車両一覧表示**
- グリッド表示（3列）
- 画像サムネイル
- 基本情報（名前、価格、年式、メーカー）
- ステータス表示（販売中、レンタル可能）
- お気に入りボタン

**フィルター・検索**
- 用途別（販売/レンタル）
- タイプ別（キャブコン、バンコン）
- メーカー別
- 価格帯
- 年式

**車両詳細ページ**
```
┌─────────────────────────────────────┐
│  画像ギャラリー（メイン+サムネイル）  │
├─────────────────────────────────────┤
│  基本情報                            │
│  - 名前、メーカー、年式              │
│  - 価格（販売/レンタル料金）          │
│  - ステータス                        │
├─────────────────────────────────────┤
│  詳細仕様                            │
│  - サイズ（長さ、幅、高さ）          │
│  - 重量、定員                        │
│  - エンジン、燃費                    │
├─────────────────────────────────────┤
│  装備・設備                          │
│  - ベッド、キッチン、トイレ等        │
├─────────────────────────────────────┤
│  アクションボタン                    │
│  - お気に入り登録                    │
│  - レンタル予約（レンタル車両の場合） │
│  - お問い合わせ                      │
├─────────────────────────────────────┤
│  レビュー・評価                      │
│  - 平均評価（5段階）                 │
│  - レビュー一覧                      │
└─────────────────────────────────────┘
```

#### 管理者向け機能

**車両管理ページ**
- 車両一覧（全車両）
- 検索・フィルター
- 新規登録ボタン
- 編集・削除アクション

**車両登録/編集フォーム**
```typescript
interface VehicleForm {
  name: string;              // 車両名（必須）
  type: string;              // タイプ（キャブコン、バンコン等）
  manufacturer: string;      // メーカー
  year: number;             // 年式
  price: number;            // 価格
  description: string;      // 説明文
  purpose: 'sale' | 'rental' | 'both'; // 用途

  // 仕様（JSONB）
  specs: {
    length: number;         // 全長（mm）
    width: number;          // 全幅（mm）
    height: number;         // 全高（mm）
    weight: number;         // 車両重量（kg）
    capacity: number;       // 定員
    fuelType: string;       // 燃料タイプ
    fuelEfficiency: number; // 燃費（km/L）
  };

  // 装備（JSONB）
  features: {
    bed: string;            // ベッド情報
    kitchen: boolean;       // キッチン有無
    bathroom: boolean;      // トイレ・シャワー
    airConditioner: boolean;// エアコン
    heater: boolean;        // ヒーター
    solarPanel: boolean;    // ソーラーパネル
    // ... その他装備
  };

  // 画像（JSONB配列）
  images: string[];         // 画像URL配列

  status: string;           // ステータス
}
```

**レンタル車両設定**
```typescript
interface RentalVehicleForm {
  vehicle_id: string;       // 車両ID
  location: string;         // 保管場所
  price_per_day: number;    // 1日あたりの料金
  status: string;           // ステータス

  // 利用可能日・不可日（JSONB配列）
  available_dates: string[];
  unavailable_dates: string[];
  maintenance_dates: string[]; // メンテナンス日

  // オプション情報（JSONB）
  options: {
    insurance: number;      // 保険料
    delivery: number;       // 配送料
    cleaning: number;       // 清掃料
  };
}
```

---

## レンタル予約機能

### 2. 予約フロー

#### 4ステップの予約プロセス

```
Step 1: 車両選択
  ↓
Step 2: 機器選択（オプション）
  ↓
Step 3: アクティビティ選択（オプション）
  ↓
Step 4: 確認・決済
```

#### Step 1: 車両選択

**レンタル車両一覧ページ**
- 利用可能な車両のみ表示
- 日付選択カレンダー
- 在庫状況リアルタイム表示
- 料金計算（日数×単価）

```typescript
interface VehicleSelection {
  rental_vehicle_id: string;
  start_date: string;  // YYYY-MM-DD
  end_date: string;    // YYYY-MM-DD
  days: number;        // 自動計算
  price_per_day: number;
  subtotal: number;    // days × price_per_day
}
```

#### Step 2: 機器選択

**レンタル機器一覧**
- カテゴリ別表示
  - テント
  - 寝袋
  - 調理器具
  - 照明機器
  - キャンプ家具
  - その他

**機器カード表示**
- 機器名
- 画像
- 1日あたりの料金
- 在庫数
- 数量選択（+/-ボタン）

```typescript
interface EquipmentSelection {
  equipment_id: string;
  name: string;
  quantity: number;
  days: number;         // レンタル日数
  price_per_day: number;
  subtotal: number;     // quantity × days × price_per_day
}
```

#### Step 3: アクティビティ選択

**アクティビティ一覧**
- 日付別表示
- 参加可能なアクティビティのみ
- 残席数表示

**アクティビティ詳細**
- 名前、説明
- 開催場所
- 所要時間
- 参加人数（最小・最大）
- 料金
- 含まれるもの
- 必要な持ち物

```typescript
interface ActivitySelection {
  activity_id: string;
  date: string;         // YYYY-MM-DD
  participants: number; // 参加人数
  price: number;        // 1人あたり
  total: number;        // participants × price
}
```

#### Step 4: 確認・決済

**予約確認画面**
```
┌─────────────────────────────────────┐
│  予約内容                            │
│  ─────────────────────────────────  │
│  車両: キャンパー デラックス          │
│  期間: 2026/3/1 〜 2026/3/3 (3日間)  │
│  料金: ¥25,000 × 3日 = ¥75,000      │
│                                     │
│  レンタル機器                        │
│  ─────────────────────────────────  │
│  - 2人用テント × 1 (3日間): ¥6,000  │
│  - カセットコンロ × 1 (3日間): ¥2,400│
│                                     │
│  アクティビティ                      │
│  ─────────────────────────────────  │
│  - 富士山麓トレッキング (2名): ¥10,000│
│                                     │
│  料金合計                            │
│  ─────────────────────────────────  │
│  小計: ¥93,400                      │
│  消費税(10%): ¥9,340                │
│  合計: ¥102,740                     │
│                                     │
│  [予約確定ボタン]                    │
└─────────────────────────────────────┘
```

**予約データ構造**
```typescript
interface Reservation {
  id: string;
  user_id: string;
  rental_vehicle_id: string;
  start_date: string;
  end_date: string;
  days: number;
  status: 'Pending' | 'Confirmed' | 'InProgress' | 'Cancelled' | 'Completed';

  // 料金
  subtotal: number;     // 小計
  tax: number;          // 消費税
  total: number;        // 合計

  // オプション情報（JSONB）
  options: {
    equipment: EquipmentSelection[];
    activities: ActivitySelection[];
  };

  // 決済情報
  payment_method?: string;
  payment_status?: string;

  created_at: string;
  updated_at: string;
}
```

### 3. 予約管理

#### ユーザー向け

**マイページ - 予約一覧**
- 予約ステータス別タブ
  - 予約中
  - 利用中
  - 完了
  - キャンセル済み
- 各予約の詳細表示
- アクション
  - 詳細表示
  - キャンセル（条件付き）
  - レビュー投稿（完了後）

#### スタッフ向け

**貸出処理（チェックアウト）**
```
┌─────────────────────────────────────┐
│  予約情報                            │
│  - 予約番号、顧客名                  │
│  - 車両、期間                        │
├─────────────────────────────────────┤
│  貸出前チェックリスト                │
│  □ 予約内容確認                     │
│  □ 本人確認書類                     │
│  □ 運転免許証確認                   │
│  □ 保険説明                         │
│  □ 使用方法説明                     │
│  □ 車両状態確認（外装・内装）        │
│  □ 燃料・走行距離確認               │
├─────────────────────────────────────┤
│  機器準備状況                        │
│  ✓ 2人用テント（準備完了）           │
│  ✓ カセットコンロ（準備完了）        │
├─────────────────────────────────────┤
│  メモ欄                              │
│  [自由記述]                          │
│                                     │
│  [貸出完了ボタン]                    │
└─────────────────────────────────────┘
```

**返却処理（チェックイン）**
```
┌─────────────────────────────────────┐
│  返却チェックリスト                  │
│  □ 車両状態確認（外装・内装）        │
│  □ 燃料確認                         │
│  □ 走行距離確認                     │
│  □ レンタル機器返却確認             │
│  □ 破損・汚損確認                   │
│  □ 清掃状態確認                     │
├─────────────────────────────────────┤
│  機器返却確認                        │
│  ✓ 2人用テント                      │
│  ✓ カセットコンロ                   │
├─────────────────────────────────────┤
│  追加料金                            │
│  - 超過走行: ¥0                     │
│  - クリーニング: ¥0                  │
│  - 破損修理: ¥0                     │
│  合計: ¥0                           │
├─────────────────────────────────────┤
│  メモ欄                              │
│  [自由記述]                          │
│                                     │
│  [返却完了ボタン]                    │
└─────────────────────────────────────┘
```

---

## コミュニティ機能

### 4. 体験記（Stories）

#### 投稿機能

**体験記作成フォーム**
```typescript
interface StoryForm {
  title: string;           // タイトル（必須）
  content: string;         // 本文（Markdown対応、必須）
  excerpt: string;         // 要約（自動生成可能）
  cover_image?: string;    // カバー画像URL
  images: string[];        // 追加画像URL配列

  // 位置情報
  location?: string;       // 場所名
  latitude?: number;       // 緯度
  longitude?: number;      // 経度

  tags: string[];          // タグ配列
  status: 'Draft' | 'Published' | 'Archived'; // ステータス
}
```

**投稿画面レイアウト**
```
┌─────────────────────────────────────┐
│  タイトル: [入力欄]                  │
├─────────────────────────────────────┤
│  カバー画像                          │
│  [画像アップロード]                  │
├─────────────────────────────────────┤
│  本文（Markdownエディタ）            │
│  [テキストエリア]                    │
│  - ツールバー（見出し、太字、リンク等）│
│  - プレビュー                        │
├─────────────────────────────────────┤
│  追加画像                            │
│  [画像アップロード（複数）]           │
├─────────────────────────────────────┤
│  位置情報                            │
│  場所: [入力欄]                      │
│  [地図で選択]                        │
├─────────────────────────────────────┤
│  タグ                                │
│  [タグ入力（カンマ区切り）]           │
├─────────────────────────────────────┤
│  [下書き保存] [公開する]             │
└─────────────────────────────────────┘
```

#### 閲覧機能

**体験記一覧ページ**
- グリッド表示（3列）
- カード形式
  - カバー画像
  - タイトル
  - 要約（100文字）
  - 著者名
  - いいね数、閲覧数
  - 投稿日

**フィルター・ソート**
- タグ別
- 場所別
- ソート
  - 新着順
  - 人気順（いいね数）
  - 閲覧数順

**体験記詳細ページ**
```
┌─────────────────────────────────────┐
│  カバー画像                          │
├─────────────────────────────────────┤
│  タイトル                            │
│  著者: ユーザー名 | 投稿日            │
│  いいね: 24 | 閲覧数: 156            │
│  [いいねボタン] [ブックマークボタン]  │
├─────────────────────────────────────┤
│  本文（Markdown表示）                │
│  - 見出し、段落                      │
│  - 画像挿入                          │
│  - リンク                            │
├─────────────────────────────────────┤
│  位置情報                            │
│  場所: 静岡県富士市                  │
│  [地図表示]                          │
├─────────────────────────────────────┤
│  タグ                                │
│  #富士山 #車中泊 #道の駅              │
├─────────────────────────────────────┤
│  質問・コメント                      │
│  [質問を投稿する]                    │
│                                     │
│  質問1: この道の駅の設備は？          │
│  └ 回答: トイレ、シャワーがあります   │
│                                     │
│  質問2: 混雑状況は？                 │
│  └ まだ回答がありません              │
└─────────────────────────────────────┘
```

#### いいね・ブックマーク

```typescript
// いいね
interface StoryLike {
  id: string;
  story_id: string;
  user_id: string;
  created_at: string;
}

// ブックマーク（お気に入り）
interface StoryFavorite {
  id: string;
  story_id: string;
  user_id: string;
  created_at: string;
}
```

#### 質問・回答

```typescript
// 質問
interface StoryQuestion {
  id: string;
  story_id: string;
  user_id: string;
  content: string;
  created_at: string;
}

// 回答
interface StoryAnswer {
  id: string;
  question_id: string;
  user_id: string;
  content: string;
  created_at: string;
}
```

### 5. Q&Aフォーラム

#### 質問投稿

**質問フォーム**
```typescript
interface QuestionForm {
  title: string;          // タイトル（必須）
  content: string;        // 内容（必須）
  category: string;       // カテゴリ
  status: 'Open' | 'Closed'; // ステータス
}
```

**カテゴリ**
- 車両について
- レンタルについて
- 車中泊スポット
- メンテナンス
- 法律・規則
- その他

#### 回答機能

**回答フォーム**
```typescript
interface AnswerForm {
  question_id: string;
  content: string;        // 回答内容（必須）
  is_accepted: boolean;   // ベストアンサーフラグ
}
```

**回答アクション**
- 役立った投票
- ベストアンサー選択（質問者のみ）
- 編集・削除（回答者のみ）

#### Q&A表示

**質問一覧ページ**
```
┌─────────────────────────────────────┐
│ [質問を投稿する]                     │
├─────────────────────────────────────┤
│ フィルター: [すべて▼] [車両について] │
│ ソート: [新着順▼]                   │
├─────────────────────────────────────┤
│ ○ 質問タイトル1                     │
│   カテゴリ: 車両について              │
│   回答: 3件 | 閲覧: 45回             │
│   投稿者: ユーザーA | 1時間前         │
├─────────────────────────────────────┤
│ ✓ 質問タイトル2 [解決済み]           │
│   カテゴリ: レンタルについて          │
│   回答: 5件 | 閲覧: 123回            │
│   投稿者: ユーザーB | 1日前           │
└─────────────────────────────────────┘
```

**質問詳細ページ**
```
┌─────────────────────────────────────┐
│  質問タイトル                        │
│  カテゴリ: 車両について | ステータス: 未解決 │
│  投稿者: ユーザーA | 1時間前          │
│  閲覧数: 45回                        │
├─────────────────────────────────────┤
│  質問内容                            │
│  [本文表示]                          │
├─────────────────────────────────────┤
│  回答 (3件)                          │
│  ─────────────────────────────────  │
│  ✓ ベストアンサー                    │
│  回答内容1                           │
│  回答者: ユーザーC | 30分前           │
│  [役立った: 5]                       │
│  ─────────────────────────────────  │
│  回答内容2                           │
│  回答者: ユーザーD | 45分前           │
│  [役立った: 2]                       │
│  ─────────────────────────────────  │
│  [回答を投稿する]                    │
└─────────────────────────────────────┘
```

### 6. レビューシステム

#### レビュー対象

- 車両（販売・レンタル）
- 協力店
- アクティビティ

#### レビュー投稿

**レビューフォーム**
```typescript
interface ReviewForm {
  target_type: 'Vehicle' | 'RentalVehicle' | 'Partner' | 'Activity';
  target_id: string;
  reservation_id?: string; // レンタル車両の場合

  rating: number;         // 1〜5（必須）
  title: string;          // タイトル
  content: string;        // 本文（必須）

  pros: string[];         // 良い点（配列）
  cons: string[];         // 悪い点（配列）

  images: string[];       // 画像URL配列
  is_published: boolean;  // 公開設定
}
```

**レビュー投稿画面**
```
┌─────────────────────────────────────┐
│  評価                                │
│  ★★★★★ (5段階)                    │
├─────────────────────────────────────┤
│  タイトル: [入力欄]                  │
├─────────────────────────────────────┤
│  レビュー内容: [テキストエリア]       │
├─────────────────────────────────────┤
│  良い点                              │
│  + [追加]                            │
│  - 項目1 [削除]                      │
│  - 項目2 [削除]                      │
├─────────────────────────────────────┤
│  悪い点                              │
│  + [追加]                            │
│  - 項目1 [削除]                      │
├─────────────────────────────────────┤
│  写真を追加                          │
│  [画像アップロード]                  │
├─────────────────────────────────────┤
│  [投稿する]                          │
└─────────────────────────────────────┘
```

#### レビュー表示

**レビュー一覧（対象ページ内）**
```
┌─────────────────────────────────────┐
│  評価・レビュー                      │
│  ─────────────────────────────────  │
│  総合評価: ★★★★☆ 4.5 (128件)      │
│  ─────────────────────────────────  │
│  ソート: [参考になった順▼]           │
│  ─────────────────────────────────  │
│  ★★★★★                            │
│  タイトル1                           │
│  良い点: 項目1、項目2                │
│  悪い点: 項目3                       │
│  本文...                             │
│  投稿者: ユーザーA | 2日前            │
│  参考になった: 12人                  │
│  [参考になったボタン]                │
│  ─────────────────────────────────  │
│  ★★★★☆                            │
│  タイトル2                           │
│  ...                                │
└─────────────────────────────────────┘
```

---

## 協力店・ルート機能

### 7. 協力店検索

#### 協力店一覧

**リスト+地図表示**
```
┌───────────────────┬─────────────────┐
│ 協力店リスト      │   地図表示       │
│                  │                 │
│ ◉ RVパーク        │   🗺️            │
│ ○ レストラン      │   [Leaflet Map] │
│ ○ 給油所          │                 │
│ ○ 観光地          │   マーカー表示   │
│                  │   - RVパーク     │
│ ─────────────── │   - レストラン   │
│                  │   - 給油所       │
│ 道の駅 富士       │   - 観光地       │
│ ★★★★☆ 4.5      │                 │
│ 静岡県富士市      │   [現在地表示]   │
│                  │                 │
│ 温泉の里 湯けむり │                 │
│ ★★★★★ 4.8      │                 │
│ 長野県松本市      │                 │
└───────────────────┴─────────────────┘
```

#### 協力店詳細

**詳細ページレイアウト**
```
┌─────────────────────────────────────┐
│  画像ギャラリー                      │
├─────────────────────────────────────┤
│  店舗名                              │
│  カテゴリ: RVパーク | 評価: ★★★★☆ 4.5 │
│  [お気に入り登録] [レビューを書く]    │
├─────────────────────────────────────┤
│  基本情報                            │
│  住所: 静岡県富士市...               │
│  電話: 0545-xx-xxxx                 │
│  営業時間: 24時間                    │
├─────────────────────────────────────┤
│  説明                                │
│  [本文表示]                          │
├─────────────────────────────────────┤
│  設備・サービス                      │
│  ✓ 電源あり                          │
│  ✓ トイレ・シャワー                  │
│  ✓ Wi-Fi                            │
│  ✓ ゴミ捨て場                        │
├─────────────────────────────────────┤
│  料金                                │
│  - 1泊: ¥2,000                      │
│  - 電源使用料: ¥500                  │
├─────────────────────────────────────┤
│  地図                                │
│  [Leaflet Map]                      │
├─────────────────────────────────────┤
│  レビュー                            │
│  [レビュー一覧表示]                  │
└─────────────────────────────────────┘
```

### 8. ルートプランニング

#### ルート作成

**ルート作成フォーム**
```typescript
interface RouteForm {
  name: string;             // ルート名（必須）
  origin: string;           // 出発地名（必須）
  destination: string;      // 目的地名（必須）
  origin_lat: number;       // 出発地緯度
  origin_lng: number;       // 出発地経度
  dest_lat: number;         // 目的地緯度
  dest_lng: number;         // 目的地経度
  description: string;      // 説明
  is_public: boolean;       // 公開設定
}

interface RouteStop {
  route_id: string;
  partner_id?: string;      // 協力店ID（該当する場合）
  stop_order: number;       // 順序
  name: string;             // 経由地名
  address: string;          // 住所
  latitude: number;
  longitude: number;
  notes: string;            // メモ
}
```

**ルート作成画面**
```
┌─────────────────────────────────────┐
│  ルート名: [入力欄]                  │
│  説明: [テキストエリア]               │
├─────────────────────────────────────┤
│  出発地: [入力欄] [地図で選択]        │
│  目的地: [入力欄] [地図で選択]        │
├─────────────────────────────────────┤
│  経由地                              │
│  1. [地図で選択 or 協力店から選択]    │
│     メモ: [入力欄]                   │
│  2. [追加]                           │
├─────────────────────────────────────┤
│  地図プレビュー                      │
│  [Leaflet Map]                      │
│  - 出発地マーカー                    │
│  - 経由地マーカー                    │
│  - 目的地マーカー                    │
│  - ルート線表示                      │
├─────────────────────────────────────┤
│  公開設定                            │
│  ○ 自分のみ                          │
│  ○ 公開する                          │
├─────────────────────────────────────┤
│  [保存する]                          │
└─────────────────────────────────────┘
```

#### ルート表示

**ルート詳細ページ**
```
┌─────────────────────────────────────┐
│  ルート名                            │
│  作成者: ユーザーA | 公開             │
│  [編集] [削除]                       │
├─────────────────────────────────────┤
│  説明                                │
│  [本文表示]                          │
├─────────────────────────────────────┤
│  地図                                │
│  [Leaflet Map - フルサイズ]          │
│  - ルート線                          │
│  - すべてのマーカー表示              │
├─────────────────────────────────────┤
│  経由地リスト                        │
│  1. 🚩 出発地: 東京都渋谷区           │
│  2. 📍 道の駅 富士                   │
│     メモ: 休憩・お土産購入            │
│  3. 📍 温泉の里 湯けむり              │
│     メモ: 温泉・宿泊                 │
│  4. 🏁 目的地: 山梨県南都留郡         │
└─────────────────────────────────────┘
```

---

## ユーザー管理機能

### 9. 認証

#### 会員登録

**登録フォーム**
```typescript
interface SignUpForm {
  email: string;          // メールアドレス（必須）
  password: string;       // パスワード（必須、8文字以上）
  first_name: string;     // 名（必須）
  last_name: string;      // 姓（必須）
  phone_number?: string;  // 電話番号

  // 住所（任意）
  postal_code?: string;   // 郵便番号
  prefecture?: string;    // 都道府県
  city?: string;          // 市区町村
  address_line?: string;  // 番地
  building?: string;      // 建物名
}
```

#### ログイン

**ログインフォーム**
```typescript
interface LoginForm {
  email: string;          // メールアドレス
  password: string;       // パスワード
}
```

**ログインフロー**
1. メール・パスワード入力
2. Supabase Auth検証
3. JWTトークン発行
4. クライアント保存
5. ユーザー情報取得
6. リダイレクト（ポータルページ）

#### パスワードリセット

**リセットフロー**
1. メールアドレス入力
2. リセットリンク送信
3. メールのリンクをクリック
4. 新しいパスワード入力
5. パスワード更新
6. 完了画面

### 10. マイページ

**マイページ構成**
```
┌─────────────────────────────────────┐
│  プロフィールヘッダー                │
│  ユーザー名 | ランク: Bronze          │
│  [プロフィール編集] [設定]            │
├─────────────────────────────────────┤
│  タブメニュー                        │
│  [概要] [予約] [投稿] [お気に入り]    │
├─────────────────────────────────────┤
│  概要タブ                            │
│  ─────────────────────────────────  │
│  最近の予約                          │
│  - 予約1 (今後)                      │
│  - 予約2 (完了)                      │
│                                     │
│  最近の投稿                          │
│  - 体験記1                           │
│  - 質問1                             │
│                                     │
│  統計情報                            │
│  - 投稿数: 5                         │
│  - いいね獲得: 24                    │
│  - レビュー数: 3                     │
└─────────────────────────────────────┘
```

**予約タブ**
- 予約一覧（ステータス別）
- 各予約の詳細表示
- アクション（キャンセル、レビュー）

**投稿タブ**
- 体験記一覧
- Q&A（質問・回答）
- レビュー一覧

**お気に入りタブ**
- 車両お気に入り
- 協力店お気に入り
- ストーリーブックマーク

### 11. プロフィール編集

**編集フォーム**
```
┌─────────────────────────────────────┐
│  基本情報                            │
│  姓: [入力欄] 名: [入力欄]            │
│  電話番号: [入力欄]                  │
├─────────────────────────────────────┤
│  住所                                │
│  郵便番号: [入力欄]                  │
│  都道府県: [選択]                    │
│  市区町村: [入力欄]                  │
│  番地: [入力欄]                      │
│  建物名: [入力欄]                    │
├─────────────────────────────────────┤
│  通知設定                            │
│  ☑ メール通知を受け取る              │
│  ☑ ストーリーへのコメント通知        │
│  ☑ レンタル関連の通知                │
│  ☑ Q&Aの回答通知                    │
├─────────────────────────────────────┤
│  プライバシー設定                    │
│  プロフィール公開: [公開▼]           │
│  ☐ メールアドレスを表示              │
│  ☐ 電話番号を表示                    │
├─────────────────────────────────────┤
│  [保存する]                          │
└─────────────────────────────────────┘
```

---

## 管理・スタッフ機能

### 12. 管理画面

詳細は実装済みのため、主要機能のみ記載。

#### 管理メニュー

- ユーザー管理
- 車両管理（販売・レンタル）
- 機器管理
- 協力店管理
- アクティビティ管理
- 予約管理
- 体験記管理
- Q&A管理
- レビュー管理
- お問い合わせ管理
- カテゴリ管理
- システム設定
- 管理ログ

### 13. スタッフ機能

#### スタッフダッシュボード

**今日の予約**
- 貸出予定（チェックアウト）
- 返却予定（チェックイン）
- 利用中

**機器準備状況**
- 準備待ち
- 準備中
- 準備完了

**お問い合わせ**
- 対応待ち
- 自分の担当

---

## 通知機能

### 14. 通知システム

#### 通知タイプ

```typescript
enum NotificationType {
  STORY_COMMENT = 'story_comment',       // 体験記へのコメント
  STORY_LIKE = 'story_like',             // 体験記へのいいね
  QUESTION_ANSWER = 'question_answer',   // 質問への回答
  ANSWER_COMMENT = 'answer_comment',     // 回答へのコメント
  RESERVATION_CONFIRMED = 'reservation_confirmed', // 予約確定
  RESERVATION_CANCELLED = 'reservation_cancelled', // 予約キャンセル
  CHECKOUT_REMINDER = 'checkout_reminder',         // 貸出日リマインダー
  RETURN_REMINDER = 'return_reminder',             // 返却日リマインダー
  SYSTEM_ANNOUNCEMENT = 'system_announcement',     // システムお知らせ
}
```

#### 通知表示

**通知ベル（ヘッダー）**
```
🔔 (3)
  ↓ クリック
┌─────────────────────────────────────┐
│  通知                                │
│  ─────────────────────────────────  │
│  ● ユーザーAさんがあなたの体験記に     │
│     コメントしました - 5分前          │
│  ─────────────────────────────────  │
│  ● 予約が確定しました - 1時間前       │
│  ─────────────────────────────────  │
│  ○ ユーザーBさんがあなたの質問に       │
│     回答しました - 2時間前            │
│  ─────────────────────────────────  │
│  [すべて表示]                        │
└─────────────────────────────────────┘
```

---

## ランクシステム

### 15. 会員ランク制度

#### 概要
利用実績に応じて自動的にランクが昇格し、ランク特典として割引が適用されるシステム。

#### ランク一覧

**Bronze（ブロンズ）**
- 初期ランク
- 条件: 新規登録時
- 特典: なし（割引率 0%）

**Silver（シルバー）**
- 条件: 以下のいずれか
  - 累計利用金額 ¥50,000以上
  - 体験記のいいね獲得数 10以上
  - 体験記の公開投稿数 3以上
- 特典: 5%割引

**Gold（ゴールド）**
- 条件: 以下のいずれか
  - 累計利用金額 ¥200,000以上
  - 体験記のいいね獲得数 30以上
  - 体験記の公開投稿数 10以上
- 特典: 10%割引

**Platinum（プラチナ）**
- 条件: 以下のいずれか
  - 累計利用金額 ¥500,000以上
  - 体験記のいいね獲得数 100以上
  - 体験記の公開投稿数 30以上
- 特典: 15%割引

#### ランク判定基準

各ランクの条件は**OR条件**で評価されます。つまり、以下のいずれか1つの条件を満たせば昇格します：
- レンタル利用の累計金額
- 体験記のいいね獲得数
- 体験記の公開投稿数

例: 累計利用金額が¥30,000でも、体験記のいいね数が10以上あればSilverランクに昇格

#### 自動ランク更新

ランクは以下のタイミングで自動的に再計算・更新されます：

**予約完了時**
- 予約ステータスが「Completed」になったとき
- 累計利用金額に反映され、自動的にランク判定

**体験記公開時**
- 体験記のステータスが「Published」になったとき
- 公開投稿数に反映され、自動的にランク判定

**いいね追加時**
- 体験記にいいねが追加されたとき
- いいね獲得数に反映され、自動的にランク判定

#### マイページでの表示

**ランク表示**
```
┌─────────────────────────────────────┐
│  ユーザー名                          │
│  ランク: 🥈 Silver                   │
│  [プロフィール編集] [設定]            │
├─────────────────────────────────────┤
│  ランク特典                          │
│  5%割引が適用されます                │
├─────────────────────────────────────┤
│  次のランクまで                      │
│  Gold (10%割引)                      │
│                                     │
│  達成条件（いずれか）:                │
│  ■■■■■□□□□□ 累計¥58,000 / ¥200,000 │
│  ■■■■□□□□□□ いいね 12 / 30      │
│  ■■■□□□□□□□ 投稿 3 / 10         │
└─────────────────────────────────────┘
```

#### 予約時の割引適用

**予約確認画面**
```
┌─────────────────────────────────────┐
│  料金合計                            │
│  ─────────────────────────────────  │
│  小計: ¥93,400                      │
│  会員割引(Silver -5%): -¥4,670      │
│  消費税(10%): ¥8,873                │
│  合計: ¥97,603                      │
└─────────────────────────────────────┘
```

割引は小計に対して適用され、その後に消費税が計算されます。

#### 管理機能

**システム設定でのランク設定管理**
```
┌─────────────────────────────────────┐
│  ランクシステム設定                  │
│  ─────────────────────────────────  │
│  Bronze                              │
│    割引率: 0%                        │
│    累計金額: ¥0                      │
│    いいね: 0                         │
│    投稿数: 0                         │
│  [編集]                              │
│  ─────────────────────────────────  │
│  Silver                              │
│    割引率: 5%                        │
│    累計金額: ¥50,000                 │
│    いいね: 10                        │
│    投稿数: 3                         │
│  [編集]                              │
│  ─────────────────────────────────  │
│  (Gold, Platinum も同様)             │
└─────────────────────────────────────┘
```

管理者は`system_settings`テーブルの`rank_settings`を編集することで、各ランクの条件と割引率を変更できます。

#### データベース構造

**ランク情報の保存**
- `users.rank`: ユーザーの現在のランク（Text: Bronze, Silver, Gold, Platinum）
- `system_settings.rank_settings`: ランクの条件と割引率（JSONB）

**関連関数**
- `calculate_total_spent(user_uuid)`: 累計利用金額を計算
- `calculate_total_likes(user_uuid)`: いいね獲得数を計算
- `calculate_total_posts(user_uuid)`: 投稿数を計算
- `determine_user_rank(user_uuid)`: ユーザーのランクを判定
- `update_user_rank(user_uuid)`: ユーザーのランクを更新
- `get_rank_discount_rate(user_rank)`: ランクの割引率を取得

**トリガー**
- 予約完了時に自動ランク更新
- 体験記公開時に自動ランク更新
- いいね追加時に自動ランク更新

---

**最終更新日**: 2026-02-07
